{% load static %}

<!DOCTYPE html>
<html>
    <head>
      <link rel="stylesheet" type="text/css" href="{% static 'fittingroom/vendor/bootstrap/css/bootstrap.min.css' %}">
      <link rel="stylesheet" type="text/css" href="{% static 'fittingroom/style.css' %}" />
      <script type="text/javascript" src="{% static 'fittingroom/vendor/jquery/jquery-3.3.1.min.js' %}"></script>

      <style>
        .butt {
          background-color: #D0B5A3;
          color: white;
          text-align: center;
          padding: 10px;
          margin: 10px;
          border-radius: 5px;
          width: 20%;
          box-shadow: 3px 3px 3px 3px;
        }

        .bubble {
          display: inline-block;
          background-color: #D0B5A3;
          color: white; 
          border-radius: 5px;
          padding-left: 10px;
          padding: 10px;
          margin-top: 3px;
          margin-bottom: 3px;
          margin-left: 10px;
          margin-right: 3px;
          overflow-x: hidden;
        }
        
        #chatbutt {
          background-color: #D0B5A3;
          text-align: center;
          color: white;
          height: 5%;
          width: 24%;
          font-size: 30px;
          border-radius: 5px;
          /* box-shadow: 3px -3px 3px 3px;  */
          position: absolute;
          padding-top: 6px;
          right: 1%;
          top: 2%;
        } 

        #chatbox {
          position: absolute; 
          padding: 1px;
          margin-top: 30px;
          border: 7px solid #D0B5A3; 
          width: 25%;
          height: 80%;
          top: 7%;
          right: 0;
        }
        #chat {
          top: 0;
          height:80%;
          overflow-y: auto;
          padding: 2%;
        }

        #chatinput {
          padding: 2%;
          position: absolute;
          bottom: 80px;
          width: 88%;
          display: inline-flex;
        }
        #msg {
          width: 80%;
        }

      </style>
    </head>


    <body>
      <div id="main-content" class="d-flex flex-column users">
        <div id = "chatbutt">
          Chat
        </div>
      </div>
      <div id = "chatbox">
        <div id = "chat">

        </div>
        <div id = "chatinput">
    
          <input type="text" id="msg">
          
          <div class = "butt">
              SEND
          </div>
        </div>
        
      </div>
      

      <div class="container-flex">
        <div class = "d-flex flex-row navBar">
          <div class ="col-3 navButton">
            <p>HOME</p>
            <img src= "{% static 'images/house.svg' %}">
          </div>
          <div class = "col-3 navButton">
            <p>OUTFIT</p>
            <img src= "{% static 'images/hanger.svg' %}">
          </div>
          <div class = "col-3 navButton selectedNav">
            <p>ROOM</p>
            <img src= "{% static 'images/curtain.svg' %}">
          </div>
          <div class = "col-3 navButton">
            <p>RESOURCES</p>
            <img src= "{% static 'images/leaf.svg' %}">
          </div>
        </div>
      </div>

    </body>
    <script>

      var cards = [];
      var uids = [];

      var uid = "";
      
      // if (newcard == true) {
      //   socket.send(newcard=false);
      // }
      // if (received.type == "card") {
      //   if (received.uid is not in uidlist) {
      //     addcard();
      //   }
      // }

      var socket = new WebSocket(
        'ws://' + window.location.host + '/ws/fittingroom');

    $( document ).ready(function() {
        var clothes = {
          
        }
        var card = {
            "type": "card",
            "uid": "",
            "clothes": clothes,
            "newCard": true
        };
        socket.onopen = () => socket.send(JSON.stringify(card));
    });

    function submitText() {
        var text = {
            "type": "text",
            // "uid": document.getElementById("name").value,
            "text": document.getElementById("msg").value
        };
        socket.send(JSON.stringify(text));
    }

    socket.onmessage = function(receivedMessage) {
        // console.log(receivedMessage);
        var received = JSON.parse(receivedMessage.data);
        console.log(received);
        console.log("socket receiving");
        
        if (received.type == "card") {
          if (uid == "") {
            if (uids.length != 0 && uids[0] != "") {
              uid = uids[0];
            }
            else {
              uid = received.uid;
            }
            
          }
          if (!uids.includes(received.uid) && received.uid != "") {
            console.log("hat: " + received.clothes.hat);

            var elem = document.createElement("img");
            elem.src = received.clothes.hat;

            $(".users").append(received.uid + " ");
            document.getElementById("main-content").appendChild(elem);
            
            uids.push(received.uid);
            cards.push(received);
          }
          
          if (received.newCard) {
            cards.push(received);
            uids.push(received.uid);
            for (var i = 0; i < cards.length; i++) {
              var card = {
                  "type": "card",
                  "uid": cards[i].uid,
                  "clothes": cards[i].clothes,
                  "newCard": false
              };
              socket.send(JSON.stringify(card));
            }
          } 
        }

        if (received.type == "text") {
            var bubble = document.createElement("div");
            bubble.classList.add("bubble");
            var message = document.createTextNode(uid + ": " + received.text);
            
            
            bubble.appendChild(message);
            var element = document.getElementById("chat");
            element.appendChild(bubble);
            element.appendChild(document.createElement("br"));
        }
    }
    
    socket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    $( ".butt" ).click(function() {
        if (!document.getElementById('msg').value == "") {
            submitText();
            document.getElementById('msg').value = "";
        }
    });

    $( "#msg" ).keypress(function(event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13' && !document.getElementById('msg').value == ""){
            submitText();
            document.getElementById('msg').value = "";
        }
    });

    $( "#chatbutt" ).click(function() {
      $( "#chatbox" ).toggle( "slow", function() {
        // Animation complete.
      });
    });

    window.setInterval(function() {
      var elem = document.getElementById('chat');
      elem.scrollTop = elem.scrollHeight;
    }, 100);
    </script>
</html>
